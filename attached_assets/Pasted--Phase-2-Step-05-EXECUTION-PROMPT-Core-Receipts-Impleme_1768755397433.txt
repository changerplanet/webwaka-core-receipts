
Phase 2 ‚Äî Step 05 EXECUTION PROMPT

Core Receipts Implementation

‚∏ª

CONTEXT (AUTHORITATIVE ‚Äî READ FIRST)

You are implementing Phase 2 ‚Äî Step 05 of the WebWaka Modular Rebuild.

This step is STRICTLY LIMITED to implementing the Core Receipts module as a TypeScript-only, headless library.

This is NOT:
	‚Ä¢	A POS receipt UI
	‚Ä¢	A printer module
	‚Ä¢	A WhatsApp delivery module
	‚Ä¢	A billing or invoicing system

This is the canonical proof and verification layer used by ALL Suites (POS, SVM, MVM, ParkHub, Church, Political, Billing, etc.).

‚∏ª

REPOSITORY (DO NOT DEVIATE)
	‚Ä¢	GitHub Repo:
https://github.com/changerplanet/webwaka-core-receipts
	‚Ä¢	Repo is public
	‚Ä¢	You MUST clone the repo first
	‚Ä¢	You MUST push directly to main (branching not required)
	‚Ä¢	Replit is authorized and preferred for this task

‚∏ª

TECH STACK (FIXED)
	‚Ä¢	Language: TypeScript
	‚Ä¢	Project type: Headless library
	‚Ä¢	No React
	‚Ä¢	No FastAPI
	‚Ä¢	No database assumptions
	‚Ä¢	No deployment target
	‚Ä¢	This package is meant to be imported by other modules

‚∏ª

APPROVED OSS STACK (MANDATORY)

You MUST use the following:
	‚Ä¢	Node.js crypto ‚Üí SHA-256 hashing
	‚Ä¢	fast-json-stable-stringify ‚Üí deterministic canonical JSON
	‚Ä¢	Jest / Vitest ‚Üí tests
	‚Ä¢	No blockchain
	‚Ä¢	No invoice engines
	‚Ä¢	No QR libraries
	‚Ä¢	No UI dependencies

‚∏ª

REQUIRED MODULE RESPONSIBILITIES

1. Receipt Creation

Implement deterministic receipt generation:

generateReceipt(input: CreateReceiptInput): Receipt

	‚Ä¢	Canonical JSON ‚Üí hash (SHA-256)
	‚Ä¢	Immutable receipt content
	‚Ä¢	Status initialized as ACTIVE
	‚Ä¢	Tenant-isolated

‚∏ª

2. Receipt Verification

verifyReceipt(tenantId, receiptId): ReceiptVerificationResult
verifyReceiptByCode(tenantId, receiptId, verificationCode)

	‚Ä¢	Recompute hash
	‚Ä¢	Detect tampering
	‚Ä¢	Deterministic verification result

‚∏ª

3. Public Verification (NO PII)

getPublicReceiptData(tenantId, receiptId)

Must return ONLY:
	‚Ä¢	Amount
	‚Ä¢	Currency
	‚Ä¢	Date
	‚Ä¢	Status
	‚Ä¢	Verification result
	‚Ä¢	Verification code

Must NEVER return:
	‚Ä¢	tenantId
	‚Ä¢	userId
	‚Ä¢	line items
	‚Ä¢	internal metadata

‚∏ª

4. Void & Refund (Event-Based)

Receipts are IMMUTABLE.

Implement:

voidReceipt(input)
refundReceipt(input)

	‚Ä¢	Status changes recorded as events
	‚Ä¢	Original hash remains provable
	‚Ä¢	Full auditability preserved

‚∏ª

5. Verification Codes
	‚Ä¢	Derive short human-readable code from hash
	‚Ä¢	Deterministic
	‚Ä¢	No randomness
	‚Ä¢	Format example: ABCD-1234

‚∏ª

STORAGE ABSTRACTION (REQUIRED)

Define interfaces only:

ReceiptStorage

Provide:
	‚Ä¢	InMemoryReceiptStorage for tests

No DB assumptions allowed.

‚∏ª

DEPENDENCIES (DECLARE IN MANIFEST)

The module MUST declare dependency on:
	‚Ä¢	webwaka-core-audit
	‚Ä¢	webwaka-core-identity

No other WebWaka dependencies allowed.

‚∏ª

TESTING (NON-NEGOTIABLE)

You MUST include tests that prove:
	1.	Receipt hash changes if content is altered
	2.	Verification fails on tampering
	3.	Public verification does not leak PII
	4.	Void does not destroy history
	5.	Refund creates verifiable state transition
	6.	Tenant isolation is enforced
	7.	Verification code maps correctly to receipt
	8.	Hard Stop Condition (below)

Coverage target:
	‚Ä¢	‚â• 80% across all metrics

‚∏ª

üî¥ HARD STOP CONDITION (MANDATORY)

Implementation is NOT COMPLETE unless this test passes:

‚ÄúA Suite can generate a receipt for a transaction and later prove‚Äîcryptographically and deterministically‚Äîthat the transaction occurred, has not been tampered with, belongs to the correct tenant, and can be publicly verified without exposing PII.‚Äù

This must be proven in tests, not documentation.

‚∏ª

FILES EXPECTED (MINIMUM)
	‚Ä¢	src/receipt-service.ts
	‚Ä¢	src/hash-utils.ts
	‚Ä¢	src/types.ts
	‚Ä¢	src/storage.ts
	‚Ä¢	src/index.ts
	‚Ä¢	tests/*.test.ts
	‚Ä¢	module.manifest.json (updated with capabilities)
	‚Ä¢	module.contract.md (updated)

‚∏ª

OUTPUT EXPECTATION

At completion, you MUST provide:
	1.	Test results summary
	2.	Coverage metrics
	3.	Final commit SHA
	4.	Explicit confirmation that Hard Stop Condition is met

Then STOP.

‚∏ª

DO NOT PROCEED TO STEP 06

Unless explicitly authorized.